#!/bin/sh
set -e
__USER="${1:-$(logname)}"
__packagemanager_file="${2:-}"
current_user_home="/home/$__USER"
all_packages_are=""
dont_install="wireless|fingerprint|bluetooth|laptop|gpu|must_purge|#install_"

kill_package_(){
	ps aux | grep "${1}" | awk '{print $2}' | xargs kill -9 >/dev/null 2>&1 || :
}

aptfixer(){   :; }

git_clone_repos(){
	[ ! -d "$current_user_home/Desktop" ] && mkdir -p "$current_user_home"/Desktop
	cd "$current_user_home"/Desktop
	
	for repo in my_stuff_installer my_stuff Theme_Stuff YadAppsStore secureMyLinux;do
		if [ ! -d "$repo" ];then
			git clone https://github.com/dari862/$repo.git
			chown -R ${__USER}:${__USER} "$repo"
		fi
	done
	
	ln -sf my_stuff_installer/For_dev/push_to_git .
	ln -sf my_stuff_installer/For_dev/dev_scripts .
	ln -sf my_stuff_installer/workon .
	chown ${__USER}:${__USER} push_to_git dev_scripts workon
}

add_all_packages_in_repo_to_var(){
	cd "$current_user_home/Desktop"
	all_packages_are="$(
		grep -E 'install_|=' \
		my_stuff_installer/core/Files_4_Distros/{disto_apps_list_common,disto_Drivers_list_common} \
		my_stuff_installer/core/Files_4_Distros/$distro_name/{disto_apps_list,disto_Drivers_list} \
		| grep -vE "${dont_install}" | grep -oP '"\K[^"]+(?=")'
	)"
}

printf ""
printf "Do you want to install all software in disto_Installapps_list disto_Drivers? [y|n]"
stty -icanon -echo time 0 min 1
yn="$(head -c1)"
stty icanon echo
if printf "%s" "$yn" | tr '[:lower:]' '[:upper:]' | grep -q "Y";then
	install_packages=true
else
	install_packages=false
fi

. "${__packagemanager_file}"
aptfixer
upgrade_now
install_packages_for_dev "featherpad git openssh-server shellcheck meld"
systemctl enable --now ssh || :
git_clone_repos

if [ "${install_packages}" = true ];then
	add_all_packages_in_repo_to_var
	install_packages_for_dev "${all_packages_are}"
	if [ -n "$failed_to_install" ];then
		echo "failed to install : $failed_to_install"
	fi
fi

echo "Done!!"
echo "Done!!"
echo "Done!!"
